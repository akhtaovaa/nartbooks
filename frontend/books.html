<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks ‚Äî –ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="layout">
        <nav class="nav">
            <div class="nav-inner">
                <a class="brand" href="index.html">NartBooks</a>
                <div class="nav-links">
                    <a href="index.html">–ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞</a>
                    <a href="books.html">–ö–∞—Ç–∞–ª–æ–≥</a>
                    <a href="favorites.html" data-auth="true" class="hidden">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
                    <a href="profile.html" data-auth="true" class="hidden">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a href="admin.html" data-admin="true" class="hidden">–ê–¥–º–∏–Ω</a>
                </div>
                <div class="nav-right">
                    <span class="muted" data-user-name></span>
                    <a href="register.html" class="btn ghost" data-guest="true">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">–í–æ–π—Ç–∏</button>
                    <button class="btn ghost hidden" data-auth="true" data-logout>–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </nav>

        <main class="page">
            <h1 class="section-title">–ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥ –º–µ—Å—è—Ü–∞</h1>

            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É..." 
                           style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                    <button class="btn primary" onclick="searchBooks()">–ù–∞–π—Ç–∏</button>
                    <button class="btn ghost" onclick="clearSearch()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <div id="booksContainer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥...</div>

            <div id="pagination" style="margin-top: 24px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;"></div>
        </main>
    </div>

    <script src="./main.js"></script>
    <script>
        let currentPage = 1;
        let currentSearch = '';
        const limit = 10;

        async function loadBooks(page = 1, search = '') {
            const container = document.getElementById('booksContainer');
            const pagination = document.getElementById('pagination');
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥...</div>';
            pagination.innerHTML = '';

            try {
                const params = new URLSearchParams({ page: page.toString(), limit: limit.toString() });
                if (search) params.append('search', search);
                
                const data = await apiFetch(`/books?${params}`);
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<div class="status">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                container.innerHTML = '<div class="flex" style="flex-direction: column; gap: 14px;"></div>';
                const flexContainer = container.querySelector('.flex');

                data.items.forEach(book => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.cursor = 'pointer';
                    card.onclick = () => window.location.href = `book.html?id=${book.id}`;
                    
                    const ratingHtml = book.avg_rating 
                        ? `<span class="tag" style="background: rgba(183, 160, 135, 0.2); color: var(--primary);">
                            ‚≠ê ${book.avg_rating.toFixed(1)}
                           </span>`
                        : '<span class="muted">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</span>';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 14px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px; font-size: 18px;">${escapeHtml(book.title)}</h3>
                                <p style="margin: 0 0 8px; color: var(--muted);">–ê–≤—Ç–æ—Ä: ${escapeHtml(book.author)}</p>
                                <p style="margin: 0 0 8px; font-size: 14px;">üìÖ ${escapeHtml(book.date)} | üìç ${escapeHtml(book.location)}</p>
                                ${book.description ? `<p style="margin: 8px 0 0; font-size: 14px; color: var(--muted);">${escapeHtml(book.description.substring(0, 150))}${book.description.length > 150 ? '...' : ''}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                ${ratingHtml}
                            </div>
                        </div>
                    `;
                    flexContainer.appendChild(card);
                });

                // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
                if (data.pages > 1) {
                    pagination.innerHTML = '';
                    for (let i = 1; i <= data.pages; i++) {
                        const btn = document.createElement('button');
                        btn.className = `btn ${i === page ? 'primary' : 'ghost'}`;
                        btn.textContent = i;
                        btn.onclick = () => {
                            currentPage = i;
                            loadBooks(i, currentSearch);
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        };
                        pagination.appendChild(btn);
                    }
                }
            } catch (err) {
                container.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞: ${err.message}</div>`;
            }
        }

        function searchBooks() {
            const search = document.getElementById('searchInput').value.trim();
            currentSearch = search;
            currentPage = 1;
            loadBooks(1, search);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            loadBooks(1, '');
        }

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchBooks();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            loadBooks();
        });
    </script>
</body>
</html>
