<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks ‚Äî –ö–Ω–∏–≥–∞</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="layout">
        <nav class="nav">
            <div class="nav-inner">
                <a class="brand" href="index.html">NartBooks</a>
                <div class="nav-links">
                    <a href="index.html">–ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞</a>
                    <a href="books.html">–ö–∞—Ç–∞–ª–æ–≥</a>
                    <a href="favorites.html" data-auth="true" class="hidden">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
                    <a href="profile.html" data-auth="true" class="hidden">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a href="admin.html" data-admin="true" class="hidden">–ê–¥–º–∏–Ω</a>
                </div>
                <div class="nav-right">
                    <span class="muted" data-user-name></span>
                    <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">–í–æ–π—Ç–∏</button>
                    <button class="btn ghost hidden" data-auth="true" data-logout>–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </nav>

        <main class="page">
            <div id="bookContainer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

            <div id="reviewsSection" style="margin-top: 32px;">
                <h2 class="section-title">–û—Ç–∑—ã–≤—ã</h2>
                <div id="reviewsContainer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</div>
                <div id="reviewsPagination" style="margin-top: 16px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;"></div>
            </div>

            <div id="addReviewSection" class="card" style="margin-top: 32px; display: none;" data-auth="true">
                <h3 style="margin: 0 0 16px;">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
                <form id="reviewForm" onsubmit="addReview(event)">
                    <div style="margin-bottom: 14px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">–û—Ü–µ–Ω–∫–∞</label>
                        <select id="ratingSelect" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</option>
                            <option value="5">5 ‚Äî –û—Ç–ª–∏—á–Ω–æ</option>
                            <option value="4">4 ‚Äî –•–æ—Ä–æ—à–æ</option>
                            <option value="3">3 ‚Äî –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                            <option value="2">2 ‚Äî –ü–ª–æ—Ö–æ</option>
                            <option value="1">1 ‚Äî –û—á–µ–Ω—å –ø–ª–æ—Ö–æ</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 14px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="commentText" rows="4" placeholder="–í–∞—à –æ—Ç–∑—ã–≤..." 
                                  style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </form>
                <div id="reviewStatus" style="margin-top: 12px;"></div>
            </div>
        </main>
    </div>

    <script src="./main.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');
        let currentUser = null;
        let isFavorite = false;
        let reviewsPage = 1;
        const reviewsLimit = 10;

        async function loadBook() {
            if (!bookId) {
                document.getElementById('bookContainer').innerHTML = '<div class="status error">–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
                return;
            }

            try {
                const book = await apiFetch(`/books/${bookId}`);
                
                const ratingHtml = book.avg_rating 
                    ? `<span class="tag" style="background: rgba(183, 160, 135, 0.2); color: var(--primary); font-size: 16px; padding: 6px 12px;">
                        ‚≠ê ${book.avg_rating.toFixed(1)} / 5.0
                       </span>`
                    : '<span class="muted">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</span>';

                document.getElementById('bookContainer').innerHTML = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <h1 style="margin: 0 0 12px; font-size: 28px;">${escapeHtml(book.title)}</h1>
                                <p style="margin: 0 0 8px; font-size: 18px; color: var(--muted);">${escapeHtml(book.author)}</p>
                                <p style="margin: 8px 0; font-size: 14px;">üìÖ ${escapeHtml(book.date)} | üìç ${escapeHtml(book.location)}</p>
                            </div>
                            <div style="text-align: right;">
                                ${ratingHtml}
                            </div>
                        </div>
                        ${book.description ? `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <p style="margin: 0; line-height: 1.6; font-size: 15px;">${escapeHtml(book.description)}</p>
                        </div>` : ''}
                        <div class="actions">
                            <button class="btn primary" onclick="window.location.href='books.html'">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</button>
                            <button id="favoriteBtn" class="btn ghost hidden" data-auth="true" onclick="toggleFavorite()" style="display: none;">
                                <span id="favoriteText">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                            </button>
                        </div>
                    </div>
                `;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
                if (currentUser) {
                    checkFavorite();
                    document.getElementById('favoriteBtn').style.display = 'inline-flex';
                }

                loadReviews();
            } catch (err) {
                document.getElementById('bookContainer').innerHTML = `<div class="status error">–û—à–∏–±–∫–∞: ${err.message}</div>`;
            }
        }

        async function checkFavorite() {
            if (!currentUser) return;
            try {
                const favorites = await apiFetch("/favorites");
                isFavorite = favorites.items.some(f => f.book && f.book.id === parseInt(bookId));
                updateFavoriteButton();
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', err);
            }
        }

        async function toggleFavorite() {
            if (!currentUser) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                if (isFavorite) {
                    await apiFetch(`/favorites/${bookId}`, { method: 'DELETE' });
                    isFavorite = false;
                } else {
                    await apiFetch("/favorites", {
                        method: 'POST',
                        body: JSON.stringify({ book_id: parseInt(bookId) })
                    });
                    isFavorite = true;
                }
                updateFavoriteButton();
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('favoriteBtn');
            const text = document.getElementById('favoriteText');
            if (isFavorite) {
                btn.className = 'btn danger';
                text.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ';
            } else {
                btn.className = 'btn ghost';
                text.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
            }
        }

        async function loadReviews(page = 1) {
            const container = document.getElementById('reviewsContainer');
            const pagination = document.getElementById('reviewsPagination');
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</div>';
            pagination.innerHTML = '';

            try {
                const data = await apiFetch(`/books/${bookId}/reviews?page=${page}&limit=${reviewsLimit}`);
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<div class="status">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }

                container.innerHTML = '<div class="flex" style="flex-direction: column; gap: 14px;"></div>';
                const flexContainer = container.querySelector('.flex');

                data.items.forEach(review => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <span class="tag" style="background: rgba(183, 160, 135, 0.2); color: var(--primary);">
                                    ${'‚≠ê'.repeat(review.rating)} ${review.rating}/5
                                </span>
                            </div>
                            <span class="muted" style="font-size: 13px;">${new Date(review.created_at).toLocaleDateString('ru-RU')}</span>
                        </div>
                        ${review.comment ? `<p style="margin: 8px 0 0; line-height: 1.6;">${escapeHtml(review.comment)}</p>` : ''}
                    `;
                    flexContainer.appendChild(card);
                });

                // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤
                if (data.pages > 1) {
                    for (let i = 1; i <= data.pages; i++) {
                        const btn = document.createElement('button');
                        btn.className = `btn ${i === page ? 'primary' : 'ghost'}`;
                        btn.textContent = i;
                        btn.onclick = () => {
                            reviewsPage = i;
                            loadReviews(i);
                            window.scrollTo({ top: document.getElementById('reviewsSection').offsetTop - 20, behavior: 'smooth' });
                        };
                        pagination.appendChild(btn);
                    }
                }
            } catch (err) {
                container.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤: ${err.message}</div>`;
            }
        }

        async function addReview(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('reviewStatus');
            statusDiv.innerHTML = '<div class="loading">–û—Ç–ø—Ä–∞–≤–∫–∞...</div>';

            try {
                const rating = parseInt(document.getElementById('ratingSelect').value);
                const comment = document.getElementById('commentText').value.trim();

                await apiFetch(`/books/${bookId}/reviews`, {
                    method: 'POST',
                    body: JSON.stringify({ rating, comment: comment || null })
                });

                statusDiv.innerHTML = '<div class="status" style="border-color: #86efac; background: #f0fdf4; color: #166534;">–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</div>';
                document.getElementById('reviewForm').reset();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–Ω–∏–≥—É (—á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥) –∏ –æ—Ç–∑—ã–≤—ã
                setTimeout(() => {
                    loadBook();
                }, 1000);
            } catch (err) {
                statusDiv.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞: ${err.message}</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
            currentUser = await getCurrentUser();
            if (currentUser) {
                document.getElementById('addReviewSection').style.display = 'block';
            }
            loadBook();
        });
    </script>
</body>
</html>
