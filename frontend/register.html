<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks — Регистрация</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="layout">
        <nav class="nav">
            <div class="nav-inner">
                <a class="brand" href="index.html">NartBooks</a>
                <div class="nav-links">
                    <a href="index.html">Книга месяца</a>
                    <a href="books.html">Каталог</a>
                    <a href="favorites.html" data-auth="true" class="hidden">Избранное</a>
                    <a href="profile.html" data-auth="true" class="hidden">Профиль</a>
                    <a href="admin.html" data-admin="true" class="hidden">Админ</a>
                </div>
                <div class="nav-right">
                    <span class="muted" data-user-name></span>
                    <a href="register.html" class="btn ghost" data-guest="true">Регистрация</a>
                    <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">Войти</button>
                    <button class="btn ghost hidden" data-auth="true" data-logout>Выйти</button>
                </div>
            </div>
        </nav>

        <main class="page">
            <section class="card" style="max-width:600px; margin:40px auto;">
                <div style="text-align:center; margin-bottom:32px;">
                    <h1 class="section-title">Регистрация в NartBooks</h1>
                    <p class="muted" style="margin:0; font-size:15px;">
                        Заполните форму и подтвердите email или телефон кодом
                    </p>
                </div>

                <form id="registerForm" onsubmit="handleRegister(event)">
                    <!-- Основные данные -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px;">
                        <div>
                            <label for="firstName">Имя *</label>
                            <input id="firstName" type="text" required placeholder="Иван" autocomplete="given-name">
                        </div>
                        <div>
                            <label for="lastName">Фамилия *</label>
                            <input id="lastName" type="text" required placeholder="Иванов" autocomplete="family-name">
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px;">
                        <div>
                            <label for="regEmail">Email *</label>
                            <input id="regEmail" type="email" required placeholder="example@mail.com" autocomplete="email">
                        </div>
                        <div>
                            <label for="regPhone">Телефон</label>
                            <input id="regPhone" type="tel" placeholder="+7 (999) 123-45-67" autocomplete="tel">
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <label for="birthDate">Дата рождения</label>
                        <input id="birthDate" type="date" autocomplete="bday">
                    </div>

                    <!-- Интересы -->
                    <div style="margin-top:32px; padding-top:24px; border-top:2px solid var(--border-light);">
                        <h3 style="margin:0 0 16px; font-size:18px; color:var(--primary-dark);">Ваши интересы</h3>
                        
                        <div style="margin-bottom:16px;">
                            <label for="favAuthors">Любимые авторы (через запятую)</label>
                            <input id="favAuthors" type="text" placeholder="Лев Толстой, Фёдор Достоевский" 
                                   value="">
                        </div>

                        <div style="margin-bottom:16px;">
                            <label for="favGenres">Любимые жанры (через запятую)</label>
                            <input id="favGenres" type="text" placeholder="Роман, Детектив, Фантастика" 
                                   value="">
                        </div>

                        <div style="margin-bottom:16px;">
                            <label for="favBooks">Любимые книги (через запятую)</label>
                            <input id="favBooks" type="text" placeholder="Война и мир, Преступление и наказание" 
                                   value="">
                        </div>

                        <div style="margin-bottom:20px;">
                            <label for="discussBooks">Книги для обсуждения (через запятую)</label>
                            <input id="discussBooks" type="text" placeholder="1984, Мастер и Маргарита" 
                                   value="">
                        </div>
                    </div>

                    <!-- Шаг отправки кода -->
                    <div id="step-send-code" style="margin-top:24px;">
                        <button type="submit" class="btn primary" style="width:100%; padding:14px;">
                            Зарегистрироваться и получить код
                        </button>
                    </div>

                    <!-- Шаг ввода кода -->
                    <div id="step-verify-code" class="hidden" style="margin-top:32px; padding-top:24px; border-top:2px solid var(--border-light);">
                        <p class="muted" style="margin-bottom:16px; font-size:15px;">
                            Мы отправили код подтверждения на указанный email или телефон. Введите его ниже:
                        </p>
                        <div style="margin-bottom:20px;">
                            <label for="regCode">Код подтверждения</label>
                            <input id="regCode" type="text" maxlength="10" placeholder="000000" 
                                   style="text-align:center; font-size:20px; letter-spacing:4px; font-weight:600;">
                        </div>
                        <button type="button" id="verify-reg-btn" class="btn primary" style="width:100%; padding:14px;" onclick="handleVerifyCode()">
                            Подтвердить код и завершить регистрацию
                        </button>
                        <button type="button" id="resend-reg-btn" class="btn ghost" style="width:100%; margin-top:12px; display:none;" onclick="resendCode()">
                            Отправить код повторно
                        </button>
                        <p id="reg-timer" class="muted hidden" style="margin-top:12px; font-size:13px; text-align:center;"></p>
                    </div>

                    <div id="status" class="status hidden" style="margin-top:20px;"></div>
                </form>

                <div style="margin-top:24px; padding-top:24px; border-top:2px solid var(--border-light); text-align:center;">
                    <p class="muted" style="margin:0;">
                        Уже есть аккаунт? <a href="auth.html" style="color:var(--primary); font-weight:600;">Войти</a>
                    </p>
                </div>
            </section>
        </main>
    </div>

    <script src="./main.js"></script>
    <script>
        let registrationData = null;
        let cooldown = 0;
        let timerId = null;
        let devModeCode = null;

        document.addEventListener("DOMContentLoaded", async () => {
            await initAuth();
            const user = await getCurrentUser();
            if (user) {
                window.location.href = "profile.html";
            }
        });

        async function handleRegister(e) {
            e.preventDefault();
            const statusEl = document.getElementById("status");
            clearStatus(statusEl);

            // Собираем данные
            const parseList = (str) => str.trim() ? str.split(',').map(s => s.trim()).filter(s => s) : [];

            registrationData = {
                first_name: document.getElementById("firstName").value.trim(),
                last_name: document.getElementById("lastName").value.trim(),
                email: document.getElementById("regEmail").value.trim(),
                phone: document.getElementById("regPhone").value.trim() || null,
                birth_date: document.getElementById("birthDate").value || null,
                fav_authors: parseList(document.getElementById("favAuthors").value),
                fav_genres: parseList(document.getElementById("favGenres").value),
                fav_books: parseList(document.getElementById("favBooks").value),
                discuss_books: parseList(document.getElementById("discussBooks").value)
            };

            // Валидация
            if (!registrationData.email) {
                setStatus(statusEl, "Укажите email", "error");
                return;
            }

            const sendBtn = document.getElementById("step-send-code").querySelector("button");
            sendBtn.disabled = true;
            sendBtn.textContent = "Отправляем код...";

            try {
                // Сначала отправляем код
                const response = await apiFetch("/auth/send-code", {
                    method: "POST",
                    body: JSON.stringify({ 
                        email: registrationData.email || null, 
                        phone: registrationData.phone || null 
                    })
                });

                if (response && response.message) {
                    setStatus(statusEl, "Код отправлен. Проверьте почту или телефон.", "success");
                } else {
                    // Режим разработки
                    devModeCode = Math.floor(100000 + Math.random() * 900000).toString();
                    setStatus(statusEl, `⚠️ Режим разработки: код ${devModeCode}`, "info");
                    const devInfo = document.createElement("div");
                    devInfo.className = "status";
                    devInfo.style.marginTop = "10px";
                    devInfo.style.background = "#fff3cd";
                    devInfo.style.borderColor = "#ffc107";
                    devInfo.style.color = "#856404";
                    devInfo.innerHTML = `<strong>Режим разработки:</strong> Используйте код <strong style="font-size:18px;">${devModeCode}</strong>`;
                    statusEl.parentNode.insertBefore(devInfo, statusEl.nextSibling);
                }

                // Показываем форму ввода кода
                document.getElementById("step-send-code").style.display = "none";
                document.getElementById("step-verify-code").classList.remove("hidden");
                startTimer();

            } catch (err) {
                if (err.status === 500 || err.message.includes("Ошибка при отправке")) {
                    // Режим разработки
                    devModeCode = Math.floor(100000 + Math.random() * 900000).toString();
                    setStatus(statusEl, `⚠️ Сервис отправки недоступен. Режим разработки активирован.`, "info");
                    const devInfo = document.createElement("div");
                    devInfo.className = "status";
                    devInfo.style.marginTop = "10px";
                    devInfo.style.background = "#fff3cd";
                    devInfo.style.borderColor = "#ffc107";
                    devInfo.style.color = "#856404";
                    devInfo.innerHTML = `<strong>Режим разработки:</strong> Используйте код <strong style="font-size:18px; letter-spacing:2px;">${devModeCode}</strong>`;
                    statusEl.parentNode.insertBefore(devInfo, statusEl.nextSibling);
                    document.getElementById("step-send-code").style.display = "none";
                    document.getElementById("step-verify-code").classList.remove("hidden");
                    startTimer();
                } else if (err.message.includes("уже существует")) {
                    setStatus(statusEl, "Пользователь с таким email уже существует. <a href='auth.html'>Войдите</a>", "error");
                } else {
                    setStatus(statusEl, err.message || "Ошибка при отправке кода", "error");
                }
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "Зарегистрироваться и получить код";
            }
        }

        async function handleVerifyCode() {
            const code = document.getElementById("regCode").value.trim();
            const statusEl = document.getElementById("status");
            const verifyBtn = document.getElementById("verify-reg-btn");

            clearStatus(statusEl);
            if (!code) {
                setStatus(statusEl, "Введите код", "error");
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = "Регистрируем...";

            try {
                // Проверяем код
                const verifyRes = await apiFetch("/auth/verify-code", {
                    method: "POST",
                    body: JSON.stringify({ 
                        email: registrationData.email || null, 
                        phone: registrationData.phone || null, 
                        code 
                    })
                });

                if (!verifyRes?.access_token) {
                    setStatus(statusEl, "Неверный код или ошибка сервера", "error");
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "Подтвердить код и завершить регистрацию";
                    return;
                }

                // Сохраняем токен
                setToken(verifyRes.access_token);

                // Обновляем профиль с данными регистрации
                try {
                    await apiFetch("/me", {
                        method: "PATCH",
                        body: JSON.stringify(registrationData)
                    });
                } catch (updateErr) {
                    console.warn("Не удалось обновить профиль:", updateErr);
                    // Продолжаем даже если обновление не удалось
                }

                setStatus(statusEl, "✅ Регистрация успешна! Перенаправляем...", "success");
                setTimeout(() => {
                    window.location.href = "profile.html";
                }, 1000);

            } catch (err) {
                if (err.message.includes("Неверный код")) {
                    setStatus(statusEl, `Неверный код. ${devModeCode ? `В режиме разработки используйте: ${devModeCode}` : ''}`, "error");
                } else {
                    setStatus(statusEl, err.message || "Ошибка при регистрации", "error");
                }
                verifyBtn.disabled = false;
                verifyBtn.textContent = "Подтвердить код и завершить регистрацию";
            }
        }

        async function resendCode() {
            const statusEl = document.getElementById("status");
            clearStatus(statusEl);
            
            try {
                await apiFetch("/auth/send-code", {
                    method: "POST",
                    body: JSON.stringify({ 
                        email: registrationData.email || null, 
                        phone: registrationData.phone || null 
                    })
                });
                setStatus(statusEl, "Код отправлен повторно", "success");
                startTimer();
            } catch (err) {
                setStatus(statusEl, err.message || "Ошибка при отправке кода", "error");
            }
        }

        function startTimer() {
            const timerEl = document.getElementById("reg-timer");
            const resendBtn = document.getElementById("resend-reg-btn");
            timerEl.classList.remove("hidden");
            resendBtn.style.display = "none";
            cooldown = 60;
            updateTimerText();
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                cooldown -= 1;
                if (cooldown <= 0) {
                    clearInterval(timerId);
                    timerEl.classList.add("hidden");
                    resendBtn.style.display = "block";
                } else {
                    updateTimerText();
                }
            }, 1000);
        }

        function updateTimerText() {
            const timerEl = document.getElementById("reg-timer");
            timerEl.textContent = `Повторно отправить код можно через ${cooldown} сек`;
        }

        // Enter для отправки кода
        document.getElementById("regCode").addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleVerifyCode();
        });
    </script>
</body>
</html>
