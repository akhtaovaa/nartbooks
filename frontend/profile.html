<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks — Профиль</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="layout">
        <nav class="nav">
            <div class="nav-inner">
                <a class="brand" href="index.html">NartBooks</a>
                <div class="nav-links">
                    <a href="index.html">Книга месяца</a>
                    <a href="books.html">Каталог</a>
                    <a href="favorites.html" data-auth="true" class="hidden">Избранное</a>
                    <a href="profile.html" data-auth="true" class="hidden">Профиль</a>
                    <a href="admin.html" data-admin="true" class="hidden">Админ</a>
                </div>
                <div class="nav-right">
                    <span class="muted" data-user-name></span>
                    <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">Войти</button>
                    <button class="btn ghost hidden" data-auth="true" data-logout>Выйти</button>
                </div>
            </div>
        </nav>

        <main class="page">
            <h1 class="section-title">Мой профиль</h1>

            <div id="profileContainer" class="loading">Загрузка...</div>

            <div id="editFormSection" class="card" style="margin-top: 24px; display: none;">
                <h2 style="margin: 0 0 20px;">Редактировать профиль</h2>
                <form id="profileForm" onsubmit="updateProfile(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Имя</label>
                            <input type="text" id="firstNameInput" required
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Фамилия</label>
                            <input type="text" id="lastNameInput" required
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Телефон</label>
                            <input type="tel" id="phoneInput" placeholder="+7XXXXXXXXXX"
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Дата рождения</label>
                            <input type="date" id="birthDateInput"
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Любимые авторы (через запятую)</label>
                        <input type="text" id="favAuthorsInput" placeholder="Автор 1, Автор 2, ..."
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Любимые жанры (через запятую)</label>
                        <input type="text" id="favGenresInput" placeholder="Жанр 1, Жанр 2, ..."
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Любимые книги (через запятую)</label>
                        <input type="text" id="favBooksInput" placeholder="Книга 1, Книга 2, ..."
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Книги для обсуждения (через запятую)</label>
                        <input type="text" id="discussBooksInput" placeholder="Книга 1, Книга 2, ..."
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>

                    <div class="actions">
                        <button type="submit" class="btn primary">Сохранить изменения</button>
                        <button type="button" class="btn ghost" onclick="cancelEdit()">Отмена</button>
                    </div>
                    <div id="profileStatus" style="margin-top: 12px;"></div>
                </form>
            </div>
        </main>
    </div>

    <script src="./main.js"></script>
    <script>
        let currentProfile = null;

        async function loadProfile() {
            const container = document.getElementById('profileContainer');
            
            try {
                const profile = await apiFetch("/me");
                currentProfile = profile;

                const formatList = (arr) => arr && arr.length > 0 ? arr.join(', ') : 'Не указано';

                container.innerHTML = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                            <div>
                                <h2 style="margin: 0 0 8px; font-size: 24px;">${escapeHtml(profile.first_name || '')} ${escapeHtml(profile.last_name || '')}</h2>
                                <p class="muted" style="margin: 0;">${escapeHtml(profile.email || '')}</p>
                                ${profile.phone ? `<p class="muted" style="margin: 4px 0 0;">${escapeHtml(profile.phone)}</p>` : ''}
                                ${profile.birth_date ? `<p class="muted" style="margin: 4px 0 0;">Дата рождения: ${escapeHtml(profile.birth_date)}</p>` : ''}
                                ${profile.role ? `<p style="margin: 8px 0 0;"><span class="tag">${escapeHtml(profile.role)}</span></p>` : ''}
                            </div>
                            <button class="btn primary" onclick="startEdit()">Редактировать</button>
                        </div>

                        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                            <h3 style="margin: 0 0 12px; font-size: 18px;">Интересы</h3>
                            <div style="display: grid; gap: 12px;">
                                <div>
                                    <strong>Любимые авторы:</strong>
                                    <p style="margin: 4px 0 0; color: var(--muted);">${formatList(profile.fav_authors)}</p>
                                </div>
                                <div>
                                    <strong>Любимые жанры:</strong>
                                    <p style="margin: 4px 0 0; color: var(--muted);">${formatList(profile.fav_genres)}</p>
                                </div>
                                <div>
                                    <strong>Любимые книги:</strong>
                                    <p style="margin: 4px 0 0; color: var(--muted);">${formatList(profile.fav_books)}</p>
                                </div>
                                <div>
                                    <strong>Книги для обсуждения:</strong>
                                    <p style="margin: 4px 0 0; color: var(--muted);">${formatList(profile.discuss_books)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                if (err.message.includes('401') || err.message.includes('токен')) {
                    container.innerHTML = '<div class="status error">Необходима авторизация. <a href="auth.html">Войти</a></div>';
                } else {
                    container.innerHTML = `<div class="status error">Ошибка: ${err.message}</div>`;
                }
            }
        }

        function startEdit() {
            if (!currentProfile) return;

            document.getElementById('firstNameInput').value = currentProfile.first_name || '';
            document.getElementById('lastNameInput').value = currentProfile.last_name || '';
            document.getElementById('phoneInput').value = currentProfile.phone || '';
            document.getElementById('birthDateInput').value = currentProfile.birth_date || '';
            document.getElementById('favAuthorsInput').value = (currentProfile.fav_authors || []).join(', ');
            document.getElementById('favGenresInput').value = (currentProfile.fav_genres || []).join(', ');
            document.getElementById('favBooksInput').value = (currentProfile.fav_books || []).join(', ');
            document.getElementById('discussBooksInput').value = (currentProfile.discuss_books || []).join(', ');

            document.getElementById('editFormSection').style.display = 'block';
            window.scrollTo({ top: document.getElementById('editFormSection').offsetTop - 20, behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('editFormSection').style.display = 'none';
            document.getElementById('profileStatus').innerHTML = '';
        }

        async function updateProfile(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('profileStatus');
            statusDiv.innerHTML = '<div class="loading">Сохранение...</div>';

            try {
                const parseList = (str) => str.trim() ? str.split(',').map(s => s.trim()).filter(s => s) : [];

                const updateData = {
                    first_name: document.getElementById('firstNameInput').value.trim(),
                    last_name: document.getElementById('lastNameInput').value.trim(),
                    phone: document.getElementById('phoneInput').value.trim() || null,
                    birth_date: document.getElementById('birthDateInput').value || null,
                    fav_authors: parseList(document.getElementById('favAuthorsInput').value),
                    fav_genres: parseList(document.getElementById('favGenresInput').value),
                    fav_books: parseList(document.getElementById('favBooksInput').value),
                    discuss_books: parseList(document.getElementById('discussBooksInput').value)
                };

                await apiFetch("/me", {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                statusDiv.innerHTML = '<div class="status" style="border-color: #86efac; background: #f0fdf4; color: #166534;">Профиль успешно обновлен!</div>';
                
                setTimeout(() => {
                    loadProfile();
                    document.getElementById('editFormSection').style.display = 'none';
                }, 1000);
            } catch (err) {
                statusDiv.innerHTML = `<div class="status error">Ошибка: ${err.message}</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
            const user = await getCurrentUser();
            if (!user) {
                document.getElementById('profileContainer').innerHTML = '<div class="status error">Необходима авторизация. <a href="auth.html">Войти</a></div>';
                return;
            }
            loadProfile();
        });
    </script>
</body>
</html>
