<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks ‚Äî –ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="layout">
        <nav class="nav">
            <div class="nav-inner">
                <a class="brand" href="index.html">NartBooks</a>
                <div class="nav-links">
                    <a href="index.html">–ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞</a>
                    <a href="books.html">–ö–∞—Ç–∞–ª–æ–≥</a>
                    <a href="favorites.html" data-auth="true" class="hidden">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
                    <a href="profile.html" data-auth="true" class="hidden">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a href="admin.html" data-admin="true" class="hidden">–ê–¥–º–∏–Ω</a>
                </div>
                <div class="nav-right">
                    <span class="muted" data-user-name></span>
                    <a href="register.html" class="btn ghost" data-guest="true">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">–í–æ–π—Ç–∏</button>
                    <button class="btn ghost hidden" data-auth="true" data-logout>–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </nav>

        <main class="page">
            <section class="hero">
                <div style="text-align:center; margin-bottom:24px;">
                    <h1 class="section-title">üìö –ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞</h1>
                    <p class="muted" style="margin: 0; font-size:16px;">–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –∫–Ω–∏–∂–Ω–æ–≥–æ –∫–ª—É–±–∞ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∑—ã–≤—ã</p>
                </div>
                <div id="current-book" class="card">
                    <p id="loading-current" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ –º–µ—Å—è—Ü–∞...</p>
                    <div id="current-book-content" class="hidden"></div>
                    <div id="current-book-actions" class="actions hidden"></div>
                </div>
                <div id="status" class="status hidden"></div>
            </section>

            <section style="margin-top:40px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 class="section-title" style="margin:0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–Ω–∏–≥–∏</h2>
                    <a href="books.html" class="btn ghost">–í—Å–µ –∫–Ω–∏–≥–∏ ‚Üí</a>
                </div>
                <div id="recent-books" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </section>
        </main>
    </div>

    <script src="./main.js"></script>
    <script>

        async function loadCurrentBook() {
            const loadingEl = document.getElementById("loading-current");
            const contentEl = document.getElementById("current-book-content");
            const actionsEl = document.getElementById("current-book-actions");
            const statusEl = document.getElementById("status");

            clearStatus(statusEl);
            loadingEl.classList.remove("hidden");
            contentEl.classList.add("hidden");
            actionsEl.classList.add("hidden");

            try {
                const book = await apiFetch("/books/current");
                const avg = typeof book.avg_rating === "number" ? book.avg_rating.toFixed(1) : "‚Äî";

                const locationText = book.location ? ` ¬∑ ${escapeHtml(book.location)}` : "";
                const description = book.description ? escapeHtml(book.description) : "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ";

                const ratingStars = book.avg_rating ? '‚≠ê'.repeat(Math.round(book.avg_rating)) : '';
                contentEl.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr auto; gap:24px; align-items:start;">
                        <div>
                            <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap;">
                                <span class="tag">#${book.id}</span>
                                <span class="muted" style="font-size:14px;">üìÖ ${escapeHtml(book.date || "")}</span>
                                ${book.location ? `<span class="muted" style="font-size:14px;">üìç ${escapeHtml(book.location)}</span>` : ''}
                            </div>
                            <h2 style="margin:0 0 12px; font-size:28px; color:var(--primary-dark); line-height:1.3;">${escapeHtml(book.title)}</h2>
                            <p style="margin:0 0 16px; font-size:18px; color:var(--muted); font-weight:500;">${escapeHtml(book.author)}</p>
                            <p style="margin:0; line-height:1.7; color:var(--text);">${description}</p>
                        </div>
                        <div style="min-width:180px;">
                            <div class="card-alt" style="text-align:center; padding:20px;">
                                <div class="muted" style="font-size:13px; margin-bottom:8px;">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                                <div style="font-size:36px; font-weight:700; color:var(--primary-dark); margin-bottom:8px;">${avg}</div>
                                ${ratingStars ? `<div style="font-size:20px;">${ratingStars}</div>` : '<div class="muted" style="font-size:13px;">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</div>'}
                            </div>
                        </div>
                    </div>
                `;

                contentEl.classList.remove("hidden");
                actionsEl.innerHTML = "";
                const goToBookBtn = document.createElement("button");
                goToBookBtn.className = "btn ghost";
                goToBookBtn.textContent = "–û—Ç–∑—ã–≤—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ";
                goToBookBtn.addEventListener("click", () => {
                    window.location.href = `book.html?id=${book.id}`;
                });
                actionsEl.appendChild(goToBookBtn);

                const user = await getCurrentUser();
                if (user) {
                    const favBtn = document.createElement("button");
                    favBtn.className = "btn primary";
                    favBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ";
                    favBtn.addEventListener("click", () => addToFavorites(book.id, statusEl));
                    actionsEl.appendChild(favBtn);
                } else {
                    const loginBtn = document.createElement("button");
                    loginBtn.className = "btn primary";
                    loginBtn.textContent = "–í–æ–π—Ç–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ";
                    loginBtn.addEventListener("click", () => {
                        window.location.href = "auth.html";
                    });
                    actionsEl.appendChild(loginBtn);
                }

                actionsEl.classList.remove("hidden");
                loadingEl.classList.add("hidden");
            } catch (err) {
                loadingEl.classList.add("hidden");
                if (err.status === 404 || err.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω–∞")) {
                    contentEl.innerHTML = `
                        <div style="text-align:center; padding:40px 20px;">
                            <div style="font-size:48px; margin-bottom:16px;">üìö</div>
                            <h3 style="margin:0 0 8px; color:var(--primary-dark);">–ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</h3>
                            <p class="muted" style="margin:0;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∫–Ω–∏–≥—É –º–µ—Å—è—Ü–∞</p>
                        </div>
                    `;
                    contentEl.classList.remove("hidden");
                } else {
                    setStatus(statusEl, err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É –º–µ—Å—è—Ü–∞", "error");
                }
            }
        }

        async function addToFavorites(bookId, statusEl) {
            clearStatus(statusEl);
            try {
                await apiFetch("/favorites", {
                    method: "POST",
                    body: JSON.stringify({ book_id: bookId })
                });
                setStatus(statusEl, "‚úÖ –ö–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", "success");
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                const favBtn = statusEl.previousElementSibling?.querySelector('.btn.primary');
                if (favBtn) {
                    favBtn.textContent = "‚úì –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º";
                    favBtn.disabled = true;
                }
            } catch (err) {
                if (err.message.includes("—É–∂–µ –µ—Å—Ç—å")) {
                    setStatus(statusEl, "–ö–Ω–∏–≥–∞ —É–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º", "info");
                } else {
                    setStatus(statusEl, err.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏", "error");
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–Ω–∏–≥
        async function loadRecentBooks() {
            const container = document.getElementById("recent-books");
            try {
                const data = await apiFetch("/books?page=1&limit=3");
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<div class="status">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                
                container.innerHTML = '<div class="flex" style="flex-direction:column; gap:16px;"></div>';
                const flexContainer = container.querySelector('.flex');
                
                data.items.forEach(book => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.cursor = 'pointer';
                    card.onclick = () => window.location.href = `book.html?id=${book.id}`;
                    
                    const ratingHtml = book.avg_rating 
                        ? `<span class="tag">‚≠ê ${book.avg_rating.toFixed(1)}</span>`
                        : '<span class="muted" style="font-size:13px;">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</span>';
                    
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start; gap:16px;">
                            <div style="flex:1;">
                                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                                    <span class="tag">#${book.id}</span>
                                    <span class="muted" style="font-size:13px;">${escapeHtml(book.date || "")}</span>
                                </div>
                                <h3 style="margin:0 0 8px; font-size:20px; color:var(--primary-dark);">${escapeHtml(book.title)}</h3>
                                <p style="margin:0 0 8px; color:var(--muted); font-size:15px;">${escapeHtml(book.author)}</p>
                                ${book.description ? `<p style="margin:8px 0 0; color:var(--text); font-size:14px; line-height:1.5;">${escapeHtml(book.description.substring(0, 120))}${book.description.length > 120 ? '...' : ''}</p>` : ''}
                            </div>
                            <div style="text-align:right;">
                                ${ratingHtml}
                            </div>
                        </div>
                    `;
                    flexContainer.appendChild(card);
                });
            } catch (err) {
                container.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`;
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            await initAuth();
            await loadCurrentBook();
            await loadRecentBooks();
        });
    </script>
</body>
</html>
