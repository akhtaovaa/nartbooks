<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks — Вход</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="layout">
    <nav class="nav">
        <div class="nav-inner">
            <a class="brand" href="index.html">NartBooks</a>
            <div class="nav-links">
                <a href="index.html">Книга месяца</a>
                <a href="books.html">Каталог</a>
                <a href="favorites.html" data-auth="true" class="hidden">Избранное</a>
                <a href="profile.html" data-auth="true" class="hidden">Профиль</a>
                <a href="admin.html" data-admin="true" class="hidden">Админ</a>
            </div>
            <div class="nav-right">
                <span class="muted" data-user-name></span>
                <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">Войти</button>
                <button class="btn ghost hidden" data-auth="true" data-logout>Выйти</button>
            </div>
        </div>
    </nav>

    <main class="page">
        <section class="card" style="max-width:500px; margin:60px auto;">
            <div style="text-align:center; margin-bottom:32px;">
                <h1 class="section-title" style="margin-bottom:8px;">Вход в NartBooks</h1>
                <p class="muted" style="margin:0; font-size:15px;">
                    Введите email или телефон — мы отправим код подтверждения
                </p>
            </div>

            <div id="step-send">
                <div style="display:flex; flex-direction:column; gap:20px; margin-bottom:24px;">
                    <div>
                        <label for="email">Email</label>
                        <input id="email" type="email" placeholder="example@mail.com" autocomplete="email">
                    </div>
                    <div style="text-align:center; position:relative;">
                        <span style="background:var(--card); padding:0 12px; color:var(--muted); font-size:13px;">или</span>
                        <hr style="position:absolute; top:50%; left:0; right:0; margin:0; border:none; border-top:1px solid var(--border-light); z-index:-1;">
                    </div>
                    <div>
                        <label for="phone">Телефон</label>
                        <input id="phone" type="tel" placeholder="+7 (999) 123-45-67" autocomplete="tel">
                    </div>
                </div>
                <button id="send-btn" class="btn primary" style="width:100%; padding:14px;">Отправить код</button>
            </div>

            <div id="step-verify" class="hidden" style="margin-top:32px; padding-top:32px; border-top:2px solid var(--border-light);">
                <div style="background:var(--card-alt); padding:20px; border-radius:12px; margin-bottom:20px; border:2px solid var(--primary);">
                    <p style="margin:0 0 8px; font-weight:600; color:var(--primary-dark); font-size:15px;">
                        ✉️ Код отправлен!
                    </p>
                    <p class="muted" style="margin:0; font-size:14px;">
                        Мы отправили код подтверждения на указанный email или телефон. Введите его ниже:
                    </p>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label for="code" style="display:block; margin-bottom:8px; font-weight:600; color:var(--text);">
                        Код подтверждения
                    </label>
                    <input id="code" type="text" maxlength="10" placeholder="000000" 
                           style="width:100%; text-align:center; font-size:24px; letter-spacing:6px; font-weight:700; 
                                  padding:16px; border:2px solid var(--border); border-radius:12px;
                                  background:var(--card); color:var(--primary-dark);">
                    <p class="muted" style="margin:8px 0 0; font-size:12px; text-align:center;">
                        Введите 6-значный код из сообщения
                    </p>
                </div>
                
                <button id="verify-btn" class="btn primary" style="width:100%; padding:14px; font-size:16px;">
                    ✓ Подтвердить код
                </button>
                
                <p id="timer" class="muted hidden" style="margin-top:12px; font-size:13px; text-align:center;"></p>
                
                <button id="resend-btn" class="btn ghost" style="width:100%; margin-top:12px; display:none;" onclick="handleSendCode()">
                    ↻ Отправить код повторно
                </button>
            </div>

            <div id="status" class="status hidden" style="margin-top:20px;"></div>

            <div style="margin-top:24px; padding-top:24px; border-top:2px solid var(--border-light); text-align:center;">
                <p class="muted" style="margin:0;">
                    Нет аккаунта? <a href="register.html" style="color:var(--primary); font-weight:600;">Зарегистрироваться</a>
                </p>
            </div>
        </section>
    </main>
</div>

    <script src="./main.js"></script>
    <script>
        let cooldown = 0;
        let timerId = null;
        let devModeCode = null; // Для режима разработки

        document.addEventListener("DOMContentLoaded", async () => {
            await initAuth();

            const sendBtn = document.getElementById("send-btn");
            const verifyBtn = document.getElementById("verify-btn");

            sendBtn.addEventListener("click", handleSendCode);
            verifyBtn.addEventListener("click", handleVerifyCode);
            
            // Enter для отправки кода
            document.getElementById("email").addEventListener("keypress", (e) => {
                if (e.key === "Enter") handleSendCode();
            });
            document.getElementById("phone").addEventListener("keypress", (e) => {
                if (e.key === "Enter") handleSendCode();
            });
            
            // Обработчик для поля кода
            const codeInput = document.getElementById("code");
            if (codeInput) {
                codeInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        handleVerifyCode();
                    }
                });
                // Оставляем только цифры при вводе
                codeInput.addEventListener("input", (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
                });
                // Автоматическая отправка при вводе 6 цифр (опционально)
                codeInput.addEventListener("input", (e) => {
                    if (e.target.value.length === 6) {
                        // Можно автоматически отправить, но лучше оставить ручной контроль
                        // handleVerifyCode();
                    }
                });
            }
        });

        function startTimer() {
            const timerEl = document.getElementById("timer");
            const resendBtn = document.getElementById("resend-btn");
            if (timerEl) {
                timerEl.classList.remove("hidden");
            }
            if (resendBtn) {
                resendBtn.style.display = "none";
            }
            cooldown = 60;
            updateTimerText();
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                cooldown -= 1;
                if (cooldown <= 0) {
                    clearInterval(timerId);
                    if (timerEl) {
                        timerEl.classList.add("hidden");
                    }
                    if (resendBtn) {
                        resendBtn.style.display = "block";
                    }
                } else {
                    updateTimerText();
                }
            }, 1000);
        }

        function updateTimerText() {
            const timerEl = document.getElementById("timer");
            if (timerEl) {
                timerEl.textContent = `Повторно отправить код можно через ${cooldown} сек`;
            }
        }

    async function handleSendCode() {
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const statusEl = document.getElementById("status");
        const sendBtn = document.getElementById("send-btn");

        clearStatus(statusEl);

        if (!email && !phone) {
            setStatus(statusEl, "Укажите email или телефон", "error");
            return;
        }

        sendBtn.disabled = true;
        sendBtn.textContent = "Отправляем...";
        try {
            const response = await apiFetch("/auth/send-code", {
                method: "POST",
                body: JSON.stringify({ email: email || null, phone: phone || null })
            });
            
            // Успешная отправка
            if (response && response.message) {
                setStatus(statusEl, "✅ Код отправлен. Проверьте почту или телефон.", "success");
                
                // Показываем форму ввода кода
                const verifyStep = document.getElementById("step-verify");
                verifyStep.classList.remove("hidden");
                
                // Прокручиваем к форме ввода кода
                setTimeout(() => {
                    verifyStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
                
                // Фокус на поле ввода кода
                setTimeout(() => {
                    document.getElementById("code").focus();
                }, 300);
                
                startTimer();
            }
        } catch (err) {
            console.error("Ошибка отправки кода:", err);
            
            // Если ошибка отправки (500 или сетевые ошибки), включаем режим разработки
            if (err.status === 500 || err.message.includes("Ошибка при отправке") || err.message.includes("Failed to fetch") || err.message.includes("NetworkError")) {
                devModeCode = Math.floor(100000 + Math.random() * 900000).toString();
                setStatus(statusEl, `⚠️ Сервис отправки недоступен. Режим разработки активирован.`, "info");
                
                // Удаляем старые сообщения о режиме разработки
                const oldDevInfo = statusEl.parentNode.querySelector('.dev-mode-info');
                if (oldDevInfo) oldDevInfo.remove();
                
                const devInfo = document.createElement("div");
                devInfo.className = "status dev-mode-info";
                devInfo.style.marginTop = "10px";
                devInfo.style.background = "#fff3cd";
                devInfo.style.borderColor = "#ffc107";
                devInfo.style.color = "#856404";
                devInfo.innerHTML = `
                    <div style="margin-bottom:8px;"><strong>Режим разработки активирован</strong></div>
                    <div style="font-size:16px; text-align:center; padding:12px; background:white; border-radius:8px; margin-top:8px;">
                        <div style="font-size:12px; color:#856404; margin-bottom:4px;">Используйте этот код:</div>
                        <div style="font-size:28px; font-weight:700; letter-spacing:4px; color:#856404;">${devModeCode}</div>
                    </div>
                    <div style="margin-top:8px; font-size:12px;">Добавьте код в базу через: <code>python scripts/add_test_code.py ${email || phone} ${devModeCode}</code></div>
                `;
                statusEl.parentNode.insertBefore(devInfo, statusEl.nextSibling);
                
                // Показываем форму ввода кода
                const verifyStep = document.getElementById("step-verify");
                verifyStep.classList.remove("hidden");
                
                setTimeout(() => {
                    verifyStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    document.getElementById("code").focus();
                }, 300);
                
                startTimer();
            } else if (err.status === 429) {
                setStatus(statusEl, "⏱️ Слишком много запросов. Подождите минуту перед повторной отправкой.", "error");
            } else if (err.status === 400) {
                setStatus(statusEl, `❌ ${err.message || "Неверные данные. Проверьте email или телефон."}`, "error");
            } else {
                setStatus(statusEl, `❌ Ошибка: ${err.message || "Не удалось отправить код. Проверьте подключение к серверу."}`, "error");
            }
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = "Отправить код";
        }
    }

    async function handleVerifyCode() {
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const code = document.getElementById("code").value.trim();
        const statusEl = document.getElementById("status");
        const verifyBtn = document.getElementById("verify-btn");

        clearStatus(statusEl);
        if (!code) {
            setStatus(statusEl, "Введите код", "error");
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.textContent = "Проверяем...";
        try {
            // Режим разработки: если код совпадает с сгенерированным, создаем тестовый токен
            if (devModeCode && code === devModeCode) {
                // В режиме разработки создаем тестового пользователя через API
                // Но сначала попробуем обычную проверку
                try {
                    const res = await apiFetch("/auth/verify-code", {
                        method: "POST",
                        body: JSON.stringify({ email: email || null, phone: phone || null, code })
                    });
                    if (res?.access_token) {
                        setToken(res.access_token);
                        setStatus(statusEl, "Авторизация успешна, перенаправляем...");
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 700);
                        return;
                    }
                } catch (apiErr) {
                    // Если API не работает, показываем подсказку
                    setStatus(statusEl, "⚠️ Режим разработки: добавьте код в базу данных через API или используйте тестовый email/телефон", "error");
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "Подтвердить код";
                    return;
                }
            }
            
            const res = await apiFetch("/auth/verify-code", {
                method: "POST",
                body: JSON.stringify({ email: email || null, phone: phone || null, code })
            });
            if (res?.access_token) {
                setToken(res.access_token);
                setStatus(statusEl, "Авторизация успешна, перенаправляем...");
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 700);
            } else {
                setStatus(statusEl, "Ответ сервера без токена", "error");
            }
        } catch (err) {
            if (err.message.includes("Неверный код")) {
                setStatus(statusEl, `Неверный код. ${devModeCode ? `В режиме разработки используйте: ${devModeCode}` : ''}`, "error");
            } else {
                setStatus(statusEl, err.message || "Неверный код или ошибка сервера", "error");
            }
        } finally {
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Подтвердить код";
        }
    }
</script>
</body>
</html>

