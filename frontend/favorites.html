<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NartBooks ‚Äî –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="layout">
        <nav class="nav">
            <div class="nav-inner">
                <a class="brand" href="index.html">NartBooks</a>
                <div class="nav-links">
                    <a href="index.html">–ö–Ω–∏–≥–∞ –º–µ—Å—è—Ü–∞</a>
                    <a href="books.html">–ö–∞—Ç–∞–ª–æ–≥</a>
                    <a href="favorites.html" data-auth="true" class="hidden">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
                    <a href="profile.html" data-auth="true" class="hidden">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a href="admin.html" data-admin="true" class="hidden">–ê–¥–º–∏–Ω</a>
                </div>
                <div class="nav-right">
                    <span class="muted" data-user-name></span>
                    <button class="btn ghost" data-guest="true" onclick="window.location.href='auth.html'">–í–æ–π—Ç–∏</button>
                    <button class="btn ghost hidden" data-auth="true" data-logout>–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </nav>

        <main class="page">
            <h1 class="section-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h1>
            <div id="favoritesContainer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="pagination" style="margin-top: 24px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;"></div>
        </main>
    </div>

    <script src="./main.js"></script>
    <script>
        let currentPage = 1;
        const limit = 10;

        async function loadFavorites(page = 1) {
            const container = document.getElementById('favoritesContainer');
            const pagination = document.getElementById('pagination');
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ...</div>';
            pagination.innerHTML = '';

            try {
                const data = await apiFetch(`/favorites?page=${page}&limit=${limit}`);
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<div class="status">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥</div>';
                    return;
                }

                container.innerHTML = '<div class="flex" style="flex-direction: column; gap: 14px;"></div>';
                const flexContainer = container.querySelector('.flex');

                data.items.forEach(item => {
                    if (!item.book) return;
                    
                    const book = item.book;
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const ratingHtml = book.avg_rating 
                        ? `<span class="tag" style="background: rgba(183, 160, 135, 0.2); color: var(--primary);">
                            ‚≠ê ${book.avg_rating.toFixed(1)}
                           </span>`
                        : '<span class="muted">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</span>';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 14px;">
                            <div style="flex: 1; cursor: pointer;" onclick="window.location.href='book.html?id=${book.id}'">
                                <h3 style="margin: 0 0 8px; font-size: 18px;">${escapeHtml(book.title)}</h3>
                                <p style="margin: 0 0 8px; color: var(--muted);">–ê–≤—Ç–æ—Ä: ${escapeHtml(book.author)}</p>
                                <p style="margin: 0 0 8px; font-size: 14px;">üìÖ ${escapeHtml(book.date)} | üìç ${escapeHtml(book.location)}</p>
                                ${book.description ? `<p style="margin: 8px 0 0; font-size: 14px; color: var(--muted);">${escapeHtml(book.description.substring(0, 150))}${book.description.length > 150 ? '...' : ''}</p>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                                ${ratingHtml}
                                <button class="btn danger" onclick="removeFavorite(${book.id}, event)">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                    flexContainer.appendChild(card);
                });

                // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
                if (data.pages > 1) {
                    for (let i = 1; i <= data.pages; i++) {
                        const btn = document.createElement('button');
                        btn.className = `btn ${i === page ? 'primary' : 'ghost'}`;
                        btn.textContent = i;
                        btn.onclick = () => {
                            currentPage = i;
                            loadFavorites(i);
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        };
                        pagination.appendChild(btn);
                    }
                }
            } catch (err) {
                if (err.message.includes('401') || err.message.includes('—Ç–æ–∫–µ–Ω')) {
                    container.innerHTML = '<div class="status error">–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. <a href="auth.html">–í–æ–π—Ç–∏</a></div>';
                } else {
                    container.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞: ${err.message}</div>`;
                }
            }
        }

        async function removeFavorite(bookId, event) {
            event.stopPropagation();
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) return;

            try {
                await apiFetch(`/favorites/${bookId}`, { method: 'DELETE' });
                loadFavorites(currentPage);
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
            const user = await getCurrentUser();
            if (!user) {
                document.getElementById('favoritesContainer').innerHTML = '<div class="status error">–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. <a href="auth.html">–í–æ–π—Ç–∏</a></div>';
                return;
            }
            loadFavorites();
        });
    </script>
</body>
</html>
